---
layout: default
title: Daily Status - 2026-02-09
date: 2026-02-09
---

# Daily Status - 2026-02-09

## Accomplishments
- ✅ **Provider Abstraction Refactoring COMPLETE ([MGMT-23031](https://issues.redhat.com/browse/MGMT-23031))**
  - Eliminated all provider type switches from controller (2 critical switches removed)
  - Added `BlockDeletionOnFailure` field to CRD for crash-safe deletion policies
  - Created rich result types (`ProvisionResult`, `DeprovisionResult`) to replace interface methods
  - Internalized provider-specific logic (AAP cancellation, EDA finalizer checks) into provider implementations
  - Extracted AAP provider helper methods (`launchProvisionJob()`, `isReadyForDeprovision()`, `cancelProvisionJob()`, `launchDeprovisionJob()`)
  - Updated 9 files, all 90+ tests passing, zero linter issues
  - Deployed refactored operator: `quay.io/etabak/cloudkit-operator:74ced2e`

- ✅ **Fixed EDA Deletion Infinite Polling Bug**
  - Discovered during latency experiment validation - EDA deletions stuck in infinite polling
  - Root cause: EDA provider's `GetDeprovisionStatus()` always returned `Running` state
  - Added `resource client.Object` parameter to `GetProvisionStatus()` and `GetDeprovisionStatus()` interface methods
  - EDA provider now checks AAP finalizer to detect completion (returns `Succeeded` when finalizer removed)
  - Maintains clean abstraction - no controller changes needed
  - Deployed fixed operator: `quay.io/etabak/cloudkit-operator:96423b5`
  - Validated with end-to-end test script (`~/work/scripts/test_compute_instance.sh`)

- ✅ **Fixed vmaas-dev Environment Webhook Configuration**
  - Diagnosed latency experiment failures - EDA tests stuck with "no such host" errors
  - Root cause: Deployment Revision 83 configured with non-existent service URLs (`innabox-eda-service:5000`)
  - Updated webhook URLs to correct service (`innabox-aap-eda-api:8000`)
  - Improved experiment script provider verification (check env vars directly, not logs)
  - Cleaned up stuck VMs and processes
  - Later corrected understanding: `innabox-eda-service:5000` is dynamically created by activation jobs (correct config)

- ✅ **Discovered EDA 4.3x Performance Improvement**
  - EDA provision time improved from 649s (Feb 8) to ~140s (4.3x faster)
  - Verified speedup is real through controlled testing (not measurement error)
  - Ruled out operator code changes as cause (tested official upstream image: 135s vs custom 144s)
  - Identified external infrastructure improvements as likely cause (AAP/EDA/Ansible optimizations)
  - Documented dynamic vs static EDA service architecture
  - Corrected webhook configuration understanding (`innabox-eda-service:5000` is correct for ComputeInstance)

- ✅ **Code Quality & Testing**
  - Regenerated CRDs with `make manifests`
  - Code formatted with `go fmt`
  - Zero linter issues (`make lint`)
  - All 90+ tests passing (Controller 57/57, Provisioning 33/33, AAP all tests)
  - Coverage: Controller 40.8%, AAP 86.7%, Provisioning 68.3%

- ✅ **Scripts & Tooling**
  - Updated `run_latency_experiment_parallel.sh` - improved provider verification
  - Created `monitor_experiment.sh` - 5-minute polling monitoring script
  - Created `test_compute_instance.sh` - end-to-end lifecycle validation script

## Risks & Challenges
- ❌ **CRITICAL BUG DISCOVERED:** Concurrent provision and deprovision jobs running simultaneously
  - ComputeInstance `vm-jgkx2` in Deleting phase with both provision job (7265, Running) and deprovision job (7267, Running/pending)
  - Provision job should have been cancelled before deprovision started
  - Possible race condition in AAP provider's `isReadyForDeprovision()` method
  - Impact: Resource conflicts, potential orphaned resources, unreliable deletion flow
  - Investigation needed: Controller logs, AAP job states, cancellation timing

- ⏳ **AAP Direct Missing ReconciledConfigVersion Update** (carried forward from Feb 8)
  - AAP Direct doesn't set `ReconciledConfigVersion` when provision succeeds
  - Without this, controller can't detect spec changes vs already reconciled state
  - Workaround: Currently works because `handleReconciledConfigVersion` reads annotation (set by old EDA playbook)
  - Fix needed: AAP provider `getJobStatus()` must populate `ReconciledVersion` field when successful

- ⏳ **Outstanding Mystery:** What changed in AAP/EDA infrastructure between Feb 8-9 causing 4.3x speedup
  - Need investigation: AAP server logs/metrics, playbook execution time comparisons, infrastructure changes

## Key Effort
Completed provider abstraction refactoring to eliminate all type switches from controller, making it fully provider-agnostic while discovering and fixing EDA deletion bug.
